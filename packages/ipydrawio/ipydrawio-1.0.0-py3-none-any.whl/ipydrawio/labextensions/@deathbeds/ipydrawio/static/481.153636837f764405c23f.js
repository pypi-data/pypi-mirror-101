(self.webpackChunk_deathbeds_ipydrawio=self.webpackChunk_deathbeds_ipydrawio||[]).push([[481,527],{527:(t,e,a)=>{"use strict";a.r(e),a.d(e,{MIME_CLASS:()=>c,extensions:()=>l,default:()=>d,RenderedDiagram:()=>h});var n=a(510),s=a(557),o=a(36),r=a(649),i=a(194);const c="jp-DiagramMedia",l=s.WY.map((t=>{const{name:e}=t;return{id:`${o.NS}:rendermime-${e}`,name:e,rendererFactory:{safe:!0,mimeTypes:[t.mimetype],createRenderer:e=>(o.eM&&console.error("creating renderer"),new h(Object.assign(Object.assign({},e),{format:t})))},dataType:"string"}})),d=l;class h extends n.Panel{constructor(t){super(),this.initialized=!1,this.addClass(c),this.format=t.format,this.content=new r.S({adapter:{format:()=>this.format,urlParams:()=>{var t;let e={};const{manager:a}=h;null!=a&&(e=a.settings.composite.drawioUrlParams||{});const n=((null===(t=this.lastModel)||void 0===t?void 0:t.metadata)[this.format.mimetype]||{}).drawioUrlParams;return null!=n&&(e=Object.assign(Object.assign({},e),n)),e},drawioUrl:()=>i.DRAWIO_URL,saveNeedsExport:()=>{var t;return(null===(t=this.format)||void 0===t?void 0:t.isTransformed)||!0},drawioConfig:()=>{var t;let e={};const{manager:a}=h;null!=a&&(e=a.settings.composite.drawioConfig||{});const n=((null===(t=this.lastModel)||void 0===t?void 0:t.metadata)[this.format.mimetype]||{}).drawioConfig;return null!=n&&(e=Object.assign(Object.assign({},e),n)),e},toXML:()=>{var t;return null==this.lastModel?"":(null===(t=this.lastModel.data[this.format.mimetype])||void 0===t?void 0:t.toString())||""},fromXML:()=>{}}}),this.layout.addWidget(this.content)}onAfterShow(){this.initialized||(this.content.onAfterShow(),this.initialized=!0),this.content.onContentChanged()}async renderModel(t){const e=t.metadata||{},a=e?e[this.format.mimetype]:null;if(null!=a){const t=a.height?`${a.height}`:"";this.node.style.minHeight=t}this.lastModel=t,this.initialized?this.content.onContentChanged():this.isVisible?this.onAfterShow():setTimeout((()=>this.onAfterShow()),100)}}},481:(t,e,a)=>{"use strict";a.r(e),a.d(e,{default:()=>P});var n=a(714),s=a(510),o=a(806),r=a(919),i=a(642),c=a(858),l=a(33),d=a(819),h=a(557),m=a(271),u=a.n(m);function g(t){var e;return(null===(e=t.status)||void 0===e?void 0:e.length)?u().createElement(n.TextItem,{onClick:t.handleClick,source:`drawio: ${t.status||"ready"}`,title:"TBDâ€¦"}):u().createElement("span",null)}class p extends r.VDomRenderer{constructor(t){super(t),this._popup=null,this.addClass(n.interactiveItem)}render(){return null==this.model?null:u().createElement(g,{handleClick:()=>this._handleClick(),status:this.model.status})}_handleClick(){const t=this._menu;this._popup&&this._popup.dispose(),t.aboutToClose.connect(this._menuClosed,this),this._popup=(0,n.showPopup)({body:t,anchor:this,align:"right"})}_menuClosed(){this.removeClass(n.clickedItem)}}!function(t){class e extends r.VDomModel{constructor(){super(...arguments),this._status=""}get status(){return this._status}set status(t){this._status!=t&&(this._status=t,this.stateChanged.emit(void 0))}}t.Model=e}(p||(p={}));var w=a(36),f=a(704),_=a(572),y=(a(186),a(649));class x extends _.DocumentWidget{constructor(t){super(t),this.context=t.context,this._manager=t.manager,this.getSettings=t.getSettings,this._onTitleChanged(),this.context.pathChanged.connect(this._onTitleChanged,this),this.context.ready.then((async()=>{w.eM&&console.warn("format",this.format),this._onContextReady()})).catch(console.warn)}_onContextReady(){this.context.model.contentChanged.connect(this.content.onContentChanged,this.content),this.content.onContentChanged(),this.content.onAfterShow()}_onTitleChanged(){w.eM&&console.warn("contentsModel",this.context.contentsModel),this.title.label=f.PathExt.basename(this.context.localPath)}get format(){return null==this.context.contentsModel?null:this._manager.formatForModel(this.context.contentsModel)||null}updateSettings(){this.content.maybeReloadFrame(!0)}}class v extends _.ABCWidgetFactory{constructor(t){super(t),this.getSettings=t.getSettings,this.manager=t.manager}createNewWidget(t){const e=new x({context:t,content:new y.S({adapter:{format:()=>e.format,urlParams:()=>{var t;return null===(t=this.getSettings())||void 0===t?void 0:t.drawioUrlParams},drawioConfig:()=>{var t;return null===(t=this.getSettings())||void 0===t?void 0:t.drawioConfig},saveNeedsExport:()=>{var t;const a=null===(t=e.format)||void 0===t?void 0:t.isTransformed;return w.eM&&console.warn("needs export",a),null==a||a},toXML:()=>{const{model:t}=e.context,{format:a}=e;return(null==a?void 0:a.toXML)?a.toXML(t):t.toString()},drawioUrl:()=>this.manager.drawioURL,fromXML:(t,a)=>{const{format:n}=e;(null==n?void 0:n.fromXML)?n.fromXML(e.context.model,t):e.context.model.fromString(t),a&&e.context.save().catch(console.warn)}}}),getSettings:this.getSettings,manager:this.manager});return e}}var b=a(194);const C=async(t,e,a=null)=>await t.exportAs(e);class M{constructor(t){this._formats=new Map,this._trackers=new Map,this._mimeExport=new Map,this._app=t.app,this._restorer=t.restorer,this._palette=t.palette,this._browserFactory=t.browserFactory,this._status=new p.Model,this._initCommands()}_initCommands(){this._app.commands.addCommand(w.OF.createNew,{label:h.Fl.label,icon:h.EH,caption:`Create a new ${h.Fl.name} file`,execute:()=>{let t=this._browserFactory.defaultBrowser.model.path;return this.createNew(t)}})}formatForModel(t){w.eM&&console.warn("getting format",t);const{path:e}=t;let a="",n=null;for(const s of this._formats.values()){if(null!=s.wantsModel&&s.wantsModel(t))return s;e&&e.endsWith(s.ext)&&s.ext.length>a.length&&(n=s,a=s.ext)}return n||null}get drawioURL(){return b.DRAWIO_URL}get status(){return this._status}set status(t){this._status=t}get settings(){return this._settings}set settings(t){this._settings=t,this._settings.changed.connect(this._onSettingsChanged,this)}get activeWidget(){const{currentWidget:t}=this._app.shell;for(const e of this._trackers.values())if(e.currentWidget===t)return e.currentWidget;return null}createNew(t){return this._status.status=`Creating Diagram in ${t}...`,this._app.commands.execute("docmanager:new-untitled",{path:t,type:"file",ext:h.Fl.ext}).then((t=>(this._status.status="Opening Diagram...",this._app.commands.execute("docmanager:open",{path:t.path,factory:w.fO}))))}_onSettingsChanged(){this._status.status="settings changed";for(const t of this._trackers.values())t.forEach(this.updateWidgetSettings)}addFormat(t){if(w.eM&&console.warn(`adding format ${t.name}`,t),this._formats.has(t.key))throw Error(`cannot reregister ${t.key}`);this._formats.set(t.key,t),this._app.docRegistry.addFileType(Object.assign({name:t.name,contentType:t.contentType||"file",displayName:t.label,mimeTypes:[t.mimetype],extensions:[t.ext],icon:t.icon,fileFormat:t.format},t.pattern?{pattern:t.pattern}:{})),t.isExport&&(w.eM&&console.warn(`...export ${t.name}`),this._initExportCommands(t)),this._initTracker(t.modelName,t.factoryName,`drawio-${t.key}`,[t],t.isDefault?[t]:[]),w.eM&&console.warn(`...tracked ${t.name}`)}updateWidgetSettings(t){t.updateSettings()}_initExportCommands(t){const{ext:e,key:a,format:n,label:s,mimetype:o,icon:r}=t,i=t.save||String,c=async r=>{let c=this._app.shell.currentWidget,l=f.PathExt.basename(c.context.path).replace(/\.dio($|\.(svg|png|ipynb|pdf)$)/,"");this._status.status=`Exporting Diagram ${l} to ${s}...`;const d=await(t.exporter||C)(c.content,a,this._settings);if(null==d)return void(this._status.status=`Failed to export to ${s}... please retry`);this._status.status=`${l} ready, saving...`;let h=await this._app.commands.execute("docmanager:new-untitled",{path:r,type:t.contentType||"file",ext:e});const m=await this._getAvaialablePath(r,l,e);h=await this._app.serviceManager.contents.rename(h.path,m),null!=d&&await this._app.serviceManager.contents.save(h.path,Object.assign(Object.assign({},h),{format:n,mimetype:o,content:i(d)})),this._status.status=`${l} ${s} saved as ${f.PathExt.basename(m)}, launching...`;const u=this._app.docRegistry.preferredWidgetFactories(h.path).map((t=>t.name));u.length&&await this._app.commands.execute("docmanager:open",{factory:u[0],path:h.path}),this._status.status=`${f.PathExt.basename(m)} launched`};this._app.commands.addCommand(`drawio:export-${a}`,{label:`Export ${h.Fl.label} as ${s}`,icon:r,execute:()=>{let t=this._browserFactory.defaultBrowser.model.path;return c(t)},isEnabled:()=>null!=this.activeWidget}),this._palette.addItem({command:`drawio:export-${a}`,category:`${h.Fl.label} Export`})}async _getAvaialablePath(t,e,a,n=99){let s=`${e}ext`;const o={content:!1},{contents:r}=this._app.serviceManager;for(const i in[...Array(n).keys()]){const n=1==i.length?`0${i}`:`${i}`;s=f.PathExt.join(t,i?`${e}-${n}${a}`:`${e}ext`);try{const t=await r.get(s,o);console.warn("Path not available",t)}catch(t){return s}}throw new Error(`Couldn't find a writeable path for ${e}${a}`)}_initTracker(t,e,a,n,s){if(this._trackers.has(a))throw Error(e);const o=new v({modelName:t,name:e,fileTypes:n.map((({name:t})=>t)),defaultFor:s.map((({name:t})=>t)),getSettings:()=>this._settings.composite,manager:this}),i=new r.WidgetTracker({namespace:a});return this._restorer.restore(i,{command:"docmanager:open",args:t=>({path:t.context.path,factory:e}),name:t=>t.context.path}).catch(console.warn),o.widgetCreated.connect(((t,e)=>{this._status.status="Loading Diagram...",e.content.frameClicked.connect((()=>{e!==this._app.shell.currentWidget&&e.node.focus()})),e.title.icon=h.EH,e.context.pathChanged.connect((()=>i.save(e))),e.content.frameClicked.connect((t=>{this._app.shell.activateById(e.id),this._status.status=`Editing ${e.context.path}`})),e.context.ready.then((()=>{var t;if(null==e.context.contentsModel)return void console.warn("widget not ready");const{mimetype:a}=e.context.contentsModel,n=null===(t=this._mimeExport.get(a))||void 0===t?void 0:t.icon;null!=n&&(e.title.icon=n),this._status.status=`${e.context.path} ready`})).catch(console.warn),i.add(e).catch(console.warn)})),this._app.docRegistry.addWidgetFactory(o),this._trackers.set(a,i),i}}var $=a(527),S=a(81);const F={id:`${w.NS}:widgets`,requires:[S.IJupyterWidgetRegistry,w.rY],autoStart:!0,activate:(t,e,n)=>{const s={name:w.NS,version:w.q4,exports:async()=>{const t=await Promise.all([a.e(727),a.e(661),a.e(387)]).then(a.bind(a,387));return t.DiagramView.diagrmManager=n,t}};w.eM&&console.warn("registering widgets",s),e.registerWidget(s)}},P=[{activate:function(t,e,a,n,o,r,i,c){const{commands:l}=t,d=new M({app:t,restorer:a,palette:o,browserFactory:e});let m=null;c&&(m=new p(d.status),c.registerStatusItem(`${w.NS}:status`,{item:m,align:"right",rank:3,isActive:()=>null!=d.activeWidget}));for(const t of h.t6)d.addFormat(t);r.load(w.Uu).then((t=>{w.eM&&console.warn("settings loaded",t.composite),d.settings=t})).catch((t=>console.error(t))),i&&i.add({command:w.OF.createNew,rank:1,category:"Other"}),l.addCommand(w.OF.setUrlParams,{label:t=>{const{drawioUrlParams:e}=t,a=Object.entries(e||{});if(1==a.length&&t.justValue)return a.map((([t,e])=>e)).join(", ");{const t=a.map((([t,e])=>`${t}: ${e}`.trim()),"");return`${h.Fl.label} `+t.join(", ")}},isToggleable:!0,isToggled:t=>{const e=d.settings.composite.drawioUrlParams||{};for(const[a,n]of Object.entries(t.drawioUrlParams||{}))if(e.hasOwnProperty(a)&&e[a]!==n)return!1;return!0},execute:async t=>{const e=d.settings.composite.drawioUrlParams||{};await d.settings.set("drawioUrlParams",Object.assign(Object.assign({},e),t.drawioUrlParams))}});for(const t of w.oP)o.addItem({command:w.OF.setUrlParams,args:{drawioUrlParams:{ui:t}},category:`${h.Fl.label} Settings`});if(n){n.fileMenu.newMenu.addGroup([{command:w.OF.createNew}],40);const t=new s.Menu({commands:l});t.title.label=`${h.Fl.label} Theme`;for(const e of w.oP)t.addItem({command:w.OF.setUrlParams,args:{drawioUrlParams:{ui:e},justValue:!0},type:"command"});n.settingsMenu.addGroup([{submenu:t,type:"submenu"}],w.pj)}return $.RenderedDiagram.manager=d,d},id:w.Uu,requires:[c.IFileBrowserFactory,o.ILayoutRestorer,d.IMainMenu,r.ICommandPalette,i.ISettingRegistry],optional:[l.ILauncher,n.IStatusBar],provides:w.rY,autoStart:!0},F]}}]);